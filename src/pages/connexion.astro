---
import Layout from "../layouts/Layout.astro";
import logo from "../assets/images/logo-simple.svg";
---

<Layout title="TaVue - Connexion">
  <div
    class="min-h-screen bg-base-100 flex items-center justify-center py-8 px-4"
  >
    <div class="max-w-md w-full">
      <div class="flex justify-center mb-8">
        <img
          src={logo.src}
          alt="TaVue Logo"
          class="h-12 md:h-16 w-auto"
          style="max-width: 200px;"
        />
      </div>

      <div class="bg-white rounded-lg shadow-lg p-8">
        <div class="flex gap-0 mb-8 border-b border-gray-200">
          <button
            id="tab-login"
            class="flex-1 py-3 font-bold font-['Raleway'] text-center uppercase text-sm transition border-b-2 active"
            style="border-color: #A0826D; color: #A0826D;"
          >
            Se connecter
          </button>
          <button
            id="tab-signup"
            class="flex-1 py-3 font-bold font-['Raleway'] text-center uppercase text-sm transition border-b-2"
            style="border-color: transparent; color: #999;"
          >
            S'inscrire
          </button>
        </div>

        <form id="login-form" class="space-y-4">
          <div>
            <input
              type="email"
              id="login-email"
              placeholder="Entrer votre email"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <div>
            <input
              type="password"
              id="login-password"
              placeholder="Entrer votre mot de passe"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full py-3 rounded-lg font-bold font-['Raleway'] text-white uppercase text-sm transition hover:opacity-90"
            style="background-color: #A0826D;"
          >
            Se connecter
          </button>

          <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-gray-300"></div>
            <span class="text-gray-400 text-xs uppercase font-['Open Sans']"
              >ou</span
            >
            <div class="flex-1 h-px bg-gray-300"></div>
          </div>

          <button
            type="button"
            id="google-login"
            class="w-full py-3 rounded-lg font-bold font-['Raleway'] border-2 uppercase text-sm transition"
            style="border-color: #D4A574; color: #333;"
          >
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  fill="#4285F4"></path>
                <path
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  fill="#34A853"></path>
                <path
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  fill="#FBBC05"></path>
                <path
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  fill="#EA4335"></path>
              </svg>
              Continuer avec Google
            </span>
          </button>

          <p class="text-center text-xs font-['Open Sans'] text-gray-500 mt-4">
            Pas encore de compte ?
            <button
              type="button"
              id="switch-signup"
              class="font-bold"
              style="color: #A0826D;"
            >
              S'inscrire
            </button>
          </p>
        </form>

        <form id="signup-form" class="space-y-4 hidden">
          <div>
            <input
              type="text"
              id="signup-name"
              placeholder="Votre nom"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <div>
            <input
              type="email"
              id="signup-email"
              placeholder="Entrer votre email"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <div>
            <input
              type="password"
              id="signup-password"
              placeholder="Entrer votre mot de passe"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <div>
            <input
              type="password"
              id="signup-password-confirm"
              placeholder="Confirmer votre mot de passe"
              class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition font-['Open Sans']"
              style="border-color: #D4A574; background-color: #F5F1E8;"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full py-3 rounded-lg font-bold font-['Raleway'] text-white uppercase text-sm transition hover:opacity-90"
            style="background-color: #A0826D;"
          >
            S'inscrire
          </button>

          <p class="text-center text-xs font-['Open Sans'] text-gray-500 mt-4">
            Vous avez un compte ?
            <button
              type="button"
              id="switch-login"
              class="font-bold"
              style="color: #A0826D;"
            >
              Se connecter
            </button>
          </p>
        </form>

        <div
          id="message"
          class="mt-4 p-3 rounded-lg hidden text-center font-['Open Sans'] text-sm"
        >
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  input:focus {
    border-color: #a0826d !important;
    box-shadow: 0 0 0 3px rgba(160, 130, 109, 0.1);
  }

  button:focus {
    outline: none;
  }

  .hidden {
    display: none;
  }

  .active {
    color: #a0826d !important;
  }
</style>

<script>
  const POCKETBASE_URL = "http://localhost:8090";
  const POCKETBASE_COLLECTION = "users";

  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const tabLogin = document.getElementById("tab-login");
  const tabSignup = document.getElementById("tab-signup");
  const switchSignup = document.getElementById("switch-signup");
  const switchLogin = document.getElementById("switch-login");
  const messageDiv = document.getElementById("message");

  tabLogin.addEventListener("click", showLogin);
  tabSignup.addEventListener("click", showSignup);
  switchSignup.addEventListener("click", (e) => {
    e.preventDefault();
    showSignup();
  });
  switchLogin.addEventListener("click", (e) => {
    e.preventDefault();
    showLogin();
  });

  function showLogin() {
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    tabLogin.style.borderColor = "#A0826D";
    tabLogin.style.color = "#A0826D";
    tabSignup.style.borderColor = "transparent";
    tabSignup.style.color = "#999";
  }

  function showSignup() {
    loginForm.classList.add("hidden");
    signupForm.classList.remove("hidden");
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    tabSignup.style.borderColor = "#A0826D";
    tabSignup.style.color = "#A0826D";
    tabLogin.style.borderColor = "transparent";
    tabLogin.style.color = "#999";
  }

  function showMessage(message, type) {
    messageDiv.textContent = message;
    messageDiv.className = `mt-4 p-3 rounded-lg font-['Open Sans'] text-sm ${
      type === "success"
        ? "bg-green-100 text-green-700"
        : "bg-red-100 text-red-700"
    }`;
    messageDiv.classList.remove("hidden");
    setTimeout(() => {
      messageDiv.classList.add("hidden");
    }, 5000);
  }

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-password").value;

    try {
      const response = await fetch(
        `${POCKETBASE_URL}/api/collections/${POCKETBASE_COLLECTION}/auth-with-password`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identity: email, password }),
        },
      );

      const data = await response.json();

      if (response.ok) {
        localStorage.setItem("pb_auth_token", data.token);
        localStorage.setItem("pb_user", JSON.stringify(data.record));
        showMessage("✓ Connexion réussie !", "success");
        setTimeout(() => {
          window.location.href = "/";
        }, 1500);
      } else {
        showMessage(data.message || "Email ou mot de passe incorrect", "error");
      }
    } catch (error) {
      showMessage(
        "Erreur réseau - Vérifiez que PocketBase est en cours d'exécution",
        "error",
      );
      console.error(error);
    }
  });

  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("signup-name").value;
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const confirmPassword = document.getElementById(
      "signup-password-confirm",
    ).value;

    if (password !== confirmPassword) {
      showMessage("Les mots de passe ne correspondent pas", "error");
      return;
    }

    if (password.length < 8) {
      showMessage(
        "Le mot de passe doit contenir au moins 8 caractères",
        "error",
      );
      return;
    }

    try {
      const response = await fetch(
        `${POCKETBASE_URL}/api/collections/${POCKETBASE_COLLECTION}/records`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
            password,
            passwordConfirm: confirmPassword,
            name,
            emailVisibility: true,
          }),
        },
      );

      const data = await response.json();

      if (response.ok) {
        showMessage("✓ Inscription réussie ! Connexion en cours...", "success");
        setTimeout(() => {
          document.getElementById("login-email").value = email;
          document.getElementById("login-password").value = password;
          showLogin();
          loginForm.dispatchEvent(new Event("submit"));
        }, 1500);
      } else {
        const errorMsg = data.data?.email?.code
          ? "Cet email est déjà utilisé"
          : data.message || "Erreur lors de l'inscription";
        showMessage(errorMsg, "error");
      }
    } catch (error) {
      showMessage(
        "Erreur réseau - Vérifiez que PocketBase est en cours d'exécution",
        "error",
      );
      console.error(error);
    }
  });

  document.getElementById("google-login").addEventListener("click", () => {
    showMessage("Google Login sera bientôt disponible", "error");
  });
</script>
